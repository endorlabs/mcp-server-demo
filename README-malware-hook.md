# Malware Audit Hook for Cursor Agent

This repository contains a custom afterFileEdit hook that audits dependency manifest files for malware using Endor Labs' security scanning capabilities.

## Overview

The hook monitors changes to dependency manifest files and automatically scans dependencies for malware. It enforces a security policy that blocks edits when malware is detected while allowing clean dependencies to proceed.

**Note**: This implementation follows the [Cursor hooks specification](https://cursor.com/docs/agent/hooks#afterfileedit) and works by reading file content from stdin and checking for malicious dependencies.

## Files

- `malware-audit-hook.sh` - The main hook script
- `hooks.json` - Cursor hooks configuration file
- `example-cursor-config.json` - Extended configuration example
- `README-malware-hook.md` - This documentation

## Supported File Types

The hook triggers on changes to these dependency manifest files:

**Node.js:**
- `**/package.json`
- `**/package-lock.json`
- `**/yarn.lock`
- `**/pnpm-lock.yaml`

**Python:**
- `**/requirements.txt`
- `**/Pipfile`
- `**/Pipfile.lock`
- `**/pyproject.toml`
- `**/poetry.lock`

**Go:**
- `**/go.mod`
- `**/go.sum`

**Rust:**
- `**/Cargo.toml`
- `**/Cargo.lock`

**Java:**
- `**/pom.xml`
- `**/build.gradle`
- `**/build.gradle.kts`
- `**/gradle.lockfile`

**PHP:**
- `**/composer.json`
- `**/composer.lock`

## How It Works

The hook works by:

1. **File Detection**: Checks if the edited file is a dependency manifest file
2. **Dependency Extraction**: Parses the file content to extract dependency information
3. **Endor Labs API Call**: Uses `endorctl` to query the Endor Labs malware database
4. **Response Parsing**: Analyzes the API response for malware status and details
5. **Policy Enforcement**: Blocks edits if malware is detected, allows clean dependencies to proceed

### Endor Labs Integration

The hook uses Endor Labs' `QueryMalware` API to check dependencies:

```bash
endorctl api create -r QueryMalware -n oss -d '{"spec":{"package_version_names":{"names":["npm://package@version"]}}}'
```

The API returns detailed malware information including:
- **Status**: `MALWARE`, `NOT_MALWARE`, or `NOT_FOUND`
- **Summary**: Brief description of the malware
- **Reasons**: Detailed explanations of why the package is flagged
- **References**: Links to security advisories and package information

## Hook Input/Output

The hook receives file content via stdin and uses the `CURSOR_FILE_PATH` environment variable to determine the file path.

### Input
- **stdin**: File content (JSON, text, etc.)
- **Environment**: `CURSOR_FILE_PATH` contains the path to the edited file

### Output
- **Exit code 0**: Clean dependencies, edit allowed
- **Exit code 1**: Malware detected, edit blocked
- **stderr**: Status messages and malware details

## Ecosystem Prefixes

Dependencies are identified using ecosystem prefixes:

- `go://` - Go modules
- `mvn://` - Maven (format: `mvn://groupId:artifactId@version`)
- `npm://` - npm packages
- `pypi://` - PyPI packages (extras and markers stripped)
- `cargo://` - Cargo packages
- `gem://` - RubyGems
- `nuget://` - NuGet packages
- `packagist://` - Composer packages

## Security Policy

### Blocking Conditions
The hook blocks edits when:
- **Condition A**: `verdict` field equals `"malware"`
- **Condition B**: Any hit has `status` field equals `"MALWARE"`

### Fail-Open Behavior
The hook allows edits to continue when:
- Service errors occur (`endorctl_error`)
- Parse errors occur (`parse_error`)
- Unknown JSON objects are encountered

## Installation

1. **Copy the hook script** to your project directory:
   ```bash
   cp malware-audit-hook.sh /path/to/your/project/
   chmod +x /path/to/your/project/malware-audit-hook.sh
   ```

2. **Install dependencies** (BOTH REQUIRED):
   ```bash
   # Install jq for JSON parsing
   # macOS
   brew install jq
   
   # Ubuntu/Debian
   sudo apt-get install jq
   
   # CentOS/RHEL
   sudo yum install jq
   
   # Install endorctl from Endor Labs (ESSENTIAL - hook won't work without it)
   # Follow Endor Labs installation instructions
   # https://docs.endorlabs.com/
   ```

3. **Configure Cursor hooks** by creating `~/.cursor/hooks.json`:
   ```json
   {
     "version": 1,
     "hooks": {
       "afterFileEdit": [
         {
           "command": "/path/to/your/project/malware-audit-hook.sh"
         }
       ]
     }
   }
   ```

4. **Restart Cursor** to activate the hook

## Testing

You can test the hook manually:

```bash
# Test with a clean package.json
echo '{"dependencies": {"express": "^4.18.0"}}' | CURSOR_FILE_PATH="package.json" ./malware-audit-hook.sh

# Test with a known malicious package (nyc-config@0.9.0)
echo '{"dependencies": {"nyc-config": "0.9.0"}}' | CURSOR_FILE_PATH="package.json" ./malware-audit-hook.sh
```

The hook will:
- ‚úÖ Allow clean dependencies (exit code 0)
- ‚ùå Block malicious dependencies (exit code 1)
- ‚è≠Ô∏è Skip non-dependency files (exit code 0)

## Output Examples

### Clean Dependencies
```
Scanning 2 dependencies for malware using Endor Labs...
Malware audit: 0 findings (2 deps scanned)
Scanned dependencies:
  ‚Ä¢ npm://express@^4.18.0
  ‚Ä¢ npm://lodash@^4.17.21
```

### Malware Detected
```
Scanning 1 dependencies for malware using Endor Labs...
üö® MALWARE DETECTED: npm://nyc-config@0.9.0
  ‚Ä¢ Package: nyc-config@0.9.0
  ‚Ä¢ Status: MALWARE
  ‚Ä¢ Summary: Malicious code in nyc-config (npm)
  ‚Ä¢ Reasons:
    - The package has an install script, which may indicate an attempt to execute arbitrary code, exfiltrate data, or communicate with a command and control server.
    - The package contains code that exfiltrates sensitive data, which may indicate an attempt to steal user information, credentials, or other sensitive data.
‚ùå BLOCKING: Malware detected in dependencies. Edit operation cancelled.
```

### Non-Dependency File
```
Malware audit: Skipping non-dependency file
```

## Requirements

- Bash 4.0 or later
- `jq` for JSON parsing
- `endorctl` CLI tool from Endor Labs for malware detection (**ESSENTIAL - hook will not function without it**)

## Security Considerations

- The hook fails open on errors to avoid blocking legitimate development work
- All malware detection is performed by the external service
- The hook only enforces policy based on service responses
- No sensitive data is logged or stored by the hook itself

## Troubleshooting

### Common Issues

1. **jq not found**: Install jq using your package manager
2. **Permission denied**: Make sure the script is executable (`chmod +x`)
3. **JSON parse errors**: Check that your dependency detector emits valid JSON
4. **Service errors**: Verify your Endor Labs service is accessible and configured correctly

### Debug Mode

To debug the hook, you can add `set -x` at the beginning of the script to enable verbose output.

## License

This hook script is provided as-is for security auditing purposes. Please ensure compliance with your organization's security policies and Endor Labs' terms of service.
